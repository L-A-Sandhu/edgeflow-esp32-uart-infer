#!/usr/bin/env bash
set -euo pipefail

# Run ESP-IDF's idf.py with a one-shot environment.
# This script does NOT permanently modify your shell environment.

# Resolve repo root (for relative defaults)
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# IDF_PATH should point to the ESP-IDF repo root that contains export.sh
IDF_PATH_IN="${IDF_PATH:-}"

# Try common install locations when IDF_PATH is not provided.
if [[ -z "${IDF_PATH_IN}" ]]; then
  for p in "$HOME/esp-idf" "$HOME/esp/esp-idf" "/opt/esp/esp-idf"; do
    if [[ -f "$p/export.sh" ]]; then
      IDF_PATH_IN="$p"
      break
    fi
  done
fi

if [[ -z "${IDF_PATH_IN}" || ! -f "${IDF_PATH_IN}/export.sh" ]]; then
  echo "ERROR: ESP-IDF not found (export.sh missing)."
  echo "Set IDF_PATH to your ESP-IDF folder for this command, e.g.:"
  echo "  IDF_PATH=\$HOME/esp-idf ./scripts/idf <args>"
  exit 1
fi

# idf.py lives at tools/idf.py in ESP-IDF
if [[ ! -f "${IDF_PATH_IN}/tools/idf.py" ]]; then
  echo "ERROR: ESP-IDF looks incomplete (tools/idf.py missing)."
  echo "Check IDF_PATH: ${IDF_PATH_IN}"
  exit 1
fi

# Activate ESP-IDF env for this command only.
# shellcheck disable=SC1090
source "${IDF_PATH_IN}/export.sh" >/dev/null

exec "${IDF_PATH_IN}/tools/idf.py" "$@"
